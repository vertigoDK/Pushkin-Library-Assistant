# Сайт Библиотеки Пушкина

## Содержание

# Содержание

- [Установка и настройка](#установка-и-настройка)
  - [1. Клонирование репозитория](#1-клонирование-репозитория)
  - [2. Создание виртуального окружения](#2-создание-виртуального-окружения)
  - [3. Активация виртуального окружения](#3-активация-виртуального-окружения)
  - [4. Установка зависимостей](#4-установка-зависимостей)
  - [5. Настройка файла `.env`](#5-настройка-файла-env)
  - [6. Применение миграций](#6-применение-миграций)
  - [7. Запуск сервера разработки](#7-запуск-сервера-разработки)
- [Развертывание Django-проекта с Gunicorn и Nginx](#развертывание-django-проекта-с-gunicorn-и-nginx)
  - [Установка необходимых пакетов](#установка-необходимых-пакетов)
  - [Настройка проекта Django](#настройка-проекта-django)
    - [Создание директории проекта](#создание-директории-проекта)
    - [Создание и активация виртуального окружения](#создание-и-активация-виртуального-окружения)
    - [Установка зависимостей](#установка-зависимостей)
    - [Настройка файла `settings.py`](#настройка-файла-settingspy)
  - [Настройка Gunicorn](#настройка-gunicorn)
    - [Создание сокета Gunicorn](#создание-сокета-gunicorn)
    - [Создание службы Gunicorn](#создание-службы-gunicorn)
    - [Проверка конфигурации Gunicorn](#проверка-конфигурации-gunicorn)
  - [Настройка Nginx](#настройка-nginx)
    - [Создание конфигурации сайта](#создание-конфигурации-сайта)
    - [Активация конфигурации сайта](#активация-конфигурации-сайта)
    - [Проверка и перезапуск Nginx](#проверка-и-перезапуск-nginx)
  - [Запуск служб](#запуск-служб)
    - [Запуск Gunicorn](#запуск-gunicorn)
    - [Проверка создания сокета](#проверка-создания-сокета)
    - [Перезапуск Gunicorn после изменений](#перезапуск-gunicorn-после-изменений)
    - [Управление службой Gunicorn](#управление-службой-gunicorn)
  - [Применение миграций Django](#применение-миграций-django)
  - [Получение SSL-сертификата](#получение-ssl-сертификата)
    - [Установка Certbot](#установка-certbot)
    - [Получение сертификата](#получение-сертификата)
    - [Автоматическое обновление конфигурации Nginx](#автоматическое-обновление-конфигурации-nginx)
    - [Перезапуск Nginx](#перезапуск-nginx)
  - [Дополнительные команды](#дополнительные-команды)
    - [Перезагрузка демона systemd](#перезагрузка-демона-systemd)
    - [Проверка логов Gunicorn](#проверка-логов-gunicorn)
    - [Проверка логов Nginx](#проверка-логов-nginx)
- [Структура проекта](#структура-проекта)
- [Установка и настройка Flowise](#установка-и-настройка-flowise)
  - [1. Установка Node.js](#1-установка-nodejs)
  - [2. Установка Flowise](#2-установка-flowise)
  - [3. Запуск Flowise](#3-запуск-flowise)
  - [4. Запуск Flowise с аутентификацией](#4-запуск-flowise-с-аутентификацией)
  - [5. Открытие Flowise в браузере](#5-открытие-flowise-в-браузере)
  - [Docker](#docker)
    - [1. Установка Docker](#1-установка-docker)
    - [Docker Compose](#docker-compose)
- [Frontend](#frontend)
  - [Построенный проект](#построенный-проект)
- [Работа с Django](#работа-с-django)
  - [Создание суперпользователя](#создание-суперпользователя)
  - [Сбор статических файлов](#сбор-статических-файлов)
  - [Запуск тестов](#запуск-тестов)
  - [Работа с переводами](#работа-с-переводами)
    - [Создание переводов](#создание-переводов)
    - [Компиляция переводов](#компиляция-переводов)
  - [Использование Django Shell](#использование-django-shell)
  - [Доступ к административной панели](#доступ-к-административной-панели)
---

## Установка и настройка

### 1. Клонирование репозитория

```sh
git clone https://github.com/trr69/Pushkin-Library-Assistant.git
cd Pushkin-Library-Assistant
```

### 2. Создание виртуального окружения

```sh
python -m venv venv
```

### 3. Активация виртуального окружения

- **Для Unix/MacOS:**

  ```sh
  source venv/bin/activate
  ```

- **Для Windows:**

  ```sh
  venv\Scripts\activate
  ```

### 4. Установка зависимостей

```sh
pip install -r requirements.txt
```

### 5. Настройка файла `.env`

Создайте файл `.env` в корневом каталоге проекта и добавьте следующие переменные:

```env
DEBUG=False
SECRET_KEY=<django-secret-key>  # Получить ключ можно здесь: https://djecrety.ir/
DATABASE_NAME=db.sqlite3
FLOWISE_CHATFLOW=<ID чата Flowise>
FLOWISE_HOST=<Хост Flowise>
```

### 6. Применение миграций

```sh
python manage.py migrate
```

### 7. Запуск сервера разработки

```sh
python manage.py runserver
```



---

# Развертывание Django-проекта с Gunicorn и Nginx

Данное руководство поможет вам развернуть Django-приложение на сервере с использованием **Gunicorn** и **Nginx**.

## Установка необходимых пакетов

Обновите список пакетов и установите Nginx:

```sh
sudo apt-get update
sudo apt-get install nginx
```

## Настройка проекта Django

### Создание директории проекта

Рекомендуется хранить файлы сайта в каталоге `/var/www/`. Создайте директорию для вашего проекта:

```sh
sudo mkdir -p /var/www/geekhero
sudo chown $USER:$USER /var/www/geekhero
cd /var/www/geekhero
```

### Создание и активация виртуального окружения

Создайте виртуальное окружение и активируйте его:

```sh
python3 -m venv geekhero_env
source geekhero_env/bin/activate
```

### Установка зависимостей

Установите необходимые пакеты:

```sh
pip install -r requirements.txt
pip install gunicorn
```

### Настройка файла `settings.py`

В файле `settings.py` убедитесь, что указаны следующие настройки для статических файлов:

```python
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static/')
```

## Настройка Gunicorn

### Создание сокета Gunicorn

Создайте файл `/etc/systemd/system/gunicorn.socket` со следующим содержимым:

```ini
[Unit]
Description=Gunicorn socket

[Socket]
ListenStream=/run/gunicorn.sock

[Install]
WantedBy=sockets.target
```

### Создание службы Gunicorn

Создайте файл `/etc/systemd/system/gunicorn.service` со следующим содержимым:

```ini
[Unit]
Description=Gunicorn daemon
Requires=gunicorn.socket
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/geekhero
ExecStart=/var/www/geekhero/geekhero_env/bin/gunicorn \
          --workers 3 \
          --bind unix:/run/gunicorn.sock \
          pushkinLibrary.wsgi:application

[Install]
WantedBy=multi-user.target
```

**Примечание:** Убедитесь, что `WorkingDirectory` указывает на каталог, содержащий файл `manage.py`.

### Проверка конфигурации Gunicorn

Проверьте файл `gunicorn.service` на наличие ошибок:

```sh
sudo systemd-analyze verify gunicorn.service
```

## Настройка Nginx

### Создание конфигурации сайта

Создайте файл `/etc/nginx/sites-available/geekhero` со следующим содержимым:

```nginx
server {
    listen 80;
    server_name dosai.pushkinlibrary.kz www.dosai.pushkinlibrary.kz;

    location = /favicon.ico { access_log off; log_not_found off; }
    
    location /static/ {
        root /var/www/geekhero;
    }
    
    location /media/ {
        root /var/www/geekhero;
    }
    
    location / {
        include proxy_params;
        proxy_pass http://unix:/run/gunicorn.sock;
    }
}
```

### Активация конфигурации сайта

Создайте символическую ссылку в каталоге `sites-enabled`:

```sh
sudo ln -s /etc/nginx/sites-available/geekhero /etc/nginx/sites-enabled/
```

### Проверка и перезапуск Nginx

Проверьте конфигурацию Nginx:

```sh
sudo nginx -t
```

Перезапустите Nginx:

```sh
sudo systemctl restart nginx
```

## Запуск служб

### Запуск Gunicorn

Активируйте и запустите сокет Gunicorn:

```sh
sudo systemctl enable gunicorn.socket
sudo systemctl start gunicorn.socket
```

Проверьте статус службы:

```sh
sudo systemctl status gunicorn.socket
```

### Проверка создания сокета

Убедитесь, что сокет `/run/gunicorn.sock` создан:

```sh
file /run/gunicorn.sock
```

Ожидаемый вывод:

```
/run/gunicorn.sock: socket
```

### Перезапуск Gunicorn после изменений

При изменении кода приложения или HTML-шаблонов перезапустите Gunicorn:

```sh
sudo systemctl restart gunicorn
```

### Управление службой Gunicorn

- Запуск: `sudo systemctl start gunicorn`
- Остановка: `sudo systemctl stop gunicorn`
- Перезапуск: `sudo systemctl restart gunicorn`
- Статус: `sudo systemctl status gunicorn`

## Применение миграций Django

При изменении моделей данных выполните миграции:

```sh
python manage.py makemigrations
python manage.py migrate
```

## Получение SSL-сертификата

### Установка Certbot

Установите Certbot и плагин для Nginx:

```sh
sudo apt-get install certbot python3-certbot-nginx
```

### Получение сертификата

Получите SSL-сертификат для вашего домена:

```sh
sudo certbot --nginx -d example.com -d www.example.com
```

Следуйте инструкциям в терминале.

### Автоматическое обновление конфигурации Nginx

Certbot автоматически обновит конфигурацию Nginx для использования SSL.

### Перезапуск Nginx

Перезапустите Nginx для применения изменений:

```sh
sudo systemctl restart nginx
```

## Дополнительные команды

### Перезагрузка демона systemd

После изменения файлов службы необходимо перезагрузить демон systemd:

```sh
sudo systemctl daemon-reload
```

### Проверка логов Gunicorn

Просмотр логов Gunicorn:

```sh
sudo journalctl -u gunicorn
```

### Проверка логов Nginx

Просмотр логов доступа и ошибок Nginx:

```sh
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```



----



# Структура проекта

- **base/** — главный модуль проекта
  - `manage.py` — основной скрипт управления проектом
  - `settings.py` — настройки проекта
  - `urls.py` — маршрутизация URL
  - `models.py` — определение моделей данных
  - `views.py` — представления приложения

- **core/** — главное приложение

- **app/** — содержит все приложения
  - **api/** — Работа с книгами (Ирбис)
    - Отвечает за взаимодействие с системой Ирбис для работы DOSAI
    - **Основные функции**: поиск книг и выдача DOSAI

  - **chatbot_app/** — Приложение чат-бота
    - Реализует функциональность чат-бота для взаимодействия с пользователями (отдельная страница)
    - **Основные функции**: ответы на часто задаваемые вопросы, помощь в навигации по сайту, предоставление информации о доступных книгах и услугах

  - **courses_app/** — Приложение для курсов
    - Управляет библиотечными курсами
    - **Основные функции**: создание и управление курсами

  - **events_app/** — Приложение для событий
    - Управляет событиями и мероприятиями, проводимыми библиотекой
    - **Основные функции**: создание и управление событиями

  - **new_book_app/** — Приложение для добавления новинок книг
    - Отвечает за добавление новых поступлений книг в библиотеку
    - **Основные функции**: добавление информации о новых книгах

  - **news_app/** — Приложение для новостей
    - Отвечает за публикацию новостей и объявлений библиотеки
    - **Основные функции**: создание и управление новостями

  - **time_app/** — Приложение для изменения расписания
    - Управляет расписанием работы и отдыха библиотеки
    - **Основные функции**: управление расписанием работы библиотеки

- **templates/** — шаблоны HTML для рендеринга страниц
- **static/** — статические файлы (CSS, JavaScript, изображения, шрифты)
- **conf/locale/** — конфигурация переводов
  - **en/** — английская локализация
  - **kk/** — казахская локализация
  - **ru/** — русская локализация
- **database/** — файлы базы данных проекта
- **media/** — хранение загружаемых пользователями файлов



---

# Установка и настройка Flowise

**Flowise** — инструмент с открытым исходным кодом, позволяющий разработчикам создавать индивидуальные потоки оркестрации LLM и агенты искусственного интеллекта.

### 1. Установка Node.js

Скачайте и установите Node.js версии >= 18.15.0 с [официального сайта](https://nodejs.org/).

### 2. Установка Flowise

Выполните следующую команду для установки Flowise:

```sh
npm install -g flowise
```

### 3. Запуск Flowise

Для запуска Flowise используйте команду:

```sh
npx flowise start
```

### 4. Запуск Flowise с аутентификацией

Если требуется запуск с использованием имени пользователя и пароля:

```sh
npx flowise start --FLOWISE_USERNAME=user --FLOWISE_PASSWORD=1234
```

### 5. Открытие Flowise в браузере

После запуска Flowise откройте браузер и перейдите по адресу:

[http://localhost:3000](http://localhost:3000)

### Docker

#### 1. Установка Docker

- Скачайте и установите Docker с официального сайта.
    
- Проверьте установку Docker, выполнив команду:

```sh
docker --version
```


#### Docker Compose

Перейдите в папку Docker в корне проекта.

Скопируйте файл `.env.example` и вставьте его как другой файл с именем `.env`.

**Запустите**:

```
docker compose up -d
```

Откройте: http://localhost:3000

Вы можете отключить docker, выполнив:

```
docker compose stop
```

----


# Frontend

### Построенный проект

Построенный фронтенд находится в ветки `frontend` в следующем каталоге:

- **build/**
  - **css/**
  - **js/**
  - **img/**

---

## Работа с Django

### Создание суперпользователя

Для доступа к административной панели `Django` необходимо создать суперпользователя:

```sh
python manage.py createsuperuser
```

Следуйте инструкциям в терминале для установки имени пользователя, адреса электронной почты и пароля.

### Сбор статических файлов

Перед развертыванием на продакшен-сервере необходимо собрать все статические файлы:


```sh
python manage.py collectstatic
```

Эта команда соберет все статические файлы в одну директорию, определенную в настройках проекта `staticfiles/`. 

### Запуск тестов

Чтобы запустить тесты для вашего приложения, вы можете запустить их с помощью:


```sh
python manage.py test
```


### Работа с переводами

#### Создание переводов

Для создания переводов используйте команду:

```sh
django-admin makemessages -d djangojs -l en
```

Эта команда создаст файл перевода для английского языка.

#### Компиляция переводов

После внесения изменений в файлы переводов выполните компиляцию:

```sh
django-admin compilemessages
```

Эта команда скомпилирует переводы для использования в вашем приложении.

---

### Использование `Django Shell`

Django предоставляет интерактивную оболочку для взаимодействия с проектом:

```sh
python manage.py shell
```

Это полезно для быстрого тестирования моделей и выполнения операций с базой данных.


### Доступ к административной панели

Административная панель Django позволяет управлять моделями и данными:

    Запустите сервер разработки:

    sh

```sh
python manage.py runserver
```

Перейдите по адресу http://localhost:8000/admin/

Войдите с использованием учетных данных суперпользователя